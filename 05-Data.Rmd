---
output: html_document
chapter: Data analysis (in development)
editor_options:
  chunk_output_type: console
---

# Data Analysis (in development)

This section is in development. Contents will include dplyr (filter, select) and statistics (t-test, correlation, power analysis etc).

If you wish me to include other topics, please let me know. 

```{r, eval = F}
install.packages('gridExtra')
```

```{r}
library(tidyverse)
library(cowplot)
library(smplot)
library(gridExtra)
library(grid)
```

## Plotting individual data

First, you need to load data (.csv file). When you are loading your own .csv file for your data analysis, make sure you place the .csv file of your interest in the folder that has been set to the **working directory**. 

In this example, we will be using data from this paper:

**Seung Hyun Min, Alex S. Baldwin and Robert F. Hess. Ocular dominance plasticity: A binocular combination task finds no cumulative effect with repeated patching (2019). Vision Research, 161, 36-42.**

We will be creating a similar figure to **Figure 2A** using **smplot**. For the PDF copy, please visit https://www.smin95.com/pubs/min2019.pdf. 

```{r}
df <- read_csv('min2019.csv')
df$Day <- factor(df$Day)
head(df)
```

There are 4 columns in this dataframe:
- First, `Subject` refers to each participant. There are 10 participants total. 
- Next, `Day` refers to the day of testing. The participants were tested on Day 1, 2, 3, 4 and 5. We will only use Day from 1 and 5.
- `Time` refers to the number of minutes after an experimental manipulation (ex. monocular deprivation). These are 0, 3, 6, 12, 24 and 48 minutes, but in the dataframe, it says 0, 1, 2, 3, 4 and 5; we will change the labels manually. 
- The `Cbratio` column refers to the actual data that will be plotted here.  

In the example below, the plots will have different colors based on Day (1 or 5). Therefore, the values in `Day` column have to be discrete, not continuous. To make them discrte, one needs to convert the `Day` column from **double** (continuous variable) to **factor** (discrete variable).

To plot data of each subject separately, we need the dataframe to show data only from one subject. This can be achieved as shown below:

```{r}
df %>% filter(Subject == 'S1')
```

`%>%` is called the **pipe**. The above code can be read as: **filter** for all rows of the dataframe **df** that have `S1` in the `Subject` column. 

Here is another example. 

```{r}
df %>% filter(Day == 1)
```

The above code can be read as: **filter** for all rows of the dataframe **df** that have `1` in the `Day` column.

Notice that S1 is a **character** because it has an alphabet. Therefore, it needs to be written as `'S1'`. However, `1` of `Day` is **double**, which is essentially just a number digit. Therefore, it can be written as `1` with no quotation mark. 

Let's try another example.

```{r}
df %>% filter(Day == 1) %>% filter(Subject == 'S1')
```

The above code can be read as: **filter** for all rows of the dataframe **df** that have `1` in the `Day` column. Then, **filter** for all rows of the dataframe **df** that have `S1` in the `Subject` column. 

The above can also be written like the one below:

```{r}
df %>% filter(Day == 1 & Subject == 'S1') 
```

The above can be read as: **filter** for all rows of the dataframe **df** that have `1` in the `Day` column **AND** have `S1` in the `Subject` column.

```{r}
df %>% filter(Day == 1 | Subject == 'S1') 
```

The above can be read as: **filter** for all rows of the dataframe **df** that have `1` in the `Day` column **OR** have `S1` in the `Subject` column.

If you wish to see the `Cbratio` column only (i.e., data only) for rows of **df** that have `Day ==  1` and `Time == 0`, you can write it like this:

```{r}
df %>% filter(Day == 1 & Time == 0) %>% select(Cbratio)
```

There are 10 rows (i.e., 10 subjects) in this filtered data frame and 1 column, which is `Cbratio`. The above can be read as: **filter** for all rows of the dataframe **df** that have `1` in the `Day` column **AND** have `0` in the `Time` column.

Now let's plot data for each subject (S1, S5, S6, S10). Each panel shows the data of each subject for both Days 1 and 5. 

```{r, fig.width = 3.5, fig.height = 3.5}
df_s1 <- df %>% filter(Subject == 'S1') # rows of df that only contain S1 in the Subject column

# use df_s1 to plot the data of S1

s1_plot <- ggplot(data = df_s1, aes(x = Time, y = Cbratio, color = Day)) + 
  geom_point(size = 4.5) +
  geom_smooth(method = 'lm', se = F, size = 0.9) + # lm = linear regression method 
  scale_x_continuous(breaks = unique(df$Time), 
                     labels = c("0", "3", "6", "12", "24", "48")) +
  sm_hgrid() +
  scale_color_manual(values = sm_color('blue','orange')) +
  scale_y_continuous(limits = c(-3, 5.5)) +
  theme(axis.text = element_text(size = rel(1.5), color = "black")) # axis text size is 1.5x the original font size. 

print(s1_plot)
```

Then make each one for the other subjects (S1, S5, S6, S10). 

```{r, fig.width = 3.5, fig.height = 3.5}
# Subject 5
df_s5 <- df %>% filter(Subject == 'S5') # rows of df that only contain S5 in the Subject column

s5_plot <- ggplot(data = df_s5, aes(x = Time, y = Cbratio, color = Day)) + 
  geom_point(size = 4.5) +
  geom_smooth(method = 'lm', se = F, size = 0.9) + # lm = linear regression method 
  scale_x_continuous(breaks = unique(df$Time), 
                     labels = c("0", "3", "6", "12", "24", "48")) +
  sm_hgrid(legends = TRUE) + # show legends for the color
  scale_color_manual(values = sm_color('blue','orange')) +
  scale_y_continuous(limits = c(-3, 5.5)) +
  theme(axis.text = element_text(size = rel(1.5), color = "black")) + # axis text size is 1.5x the original font size. 
  theme(legend.justification = c(1,0), 
        legend.position = c(0.96, 0.65)) # location of legend (color label)

print(s5_plot)
```

```{r, fig.width = 3.5, fig.height = 3.5}
# Subject 6
df_s6 <- df %>% filter(Subject == 'S6') # rows of df that only contain S6 in the Subject column

s6_plot <- ggplot(data = df_s5, aes(x = Time, y = Cbratio, color = Day)) + 
  geom_point(size = 4.5) +
  geom_smooth(method = 'lm', se = F, size = 0.9) + # lm = linear regression method 
  scale_x_continuous(breaks = unique(df$Time), 
                     labels = c("0", "3", "6", "12", "24", "48")) +
  sm_hgrid() +
  scale_color_manual(values = sm_color('blue','orange')) +
  scale_y_continuous(limits = c(-3, 5.5))  +
  theme(axis.text = element_text(size = rel(1.5), color = "black")) # axis text size is 1.5x the original font size. 

print(s6_plot)
```

```{r, fig.width = 3.5, fig.height = 3.5}
# Subject 10

df_s10 <- df %>% filter(Subject == 'S10') # rows of df that only contain S5 in the Subject column

s10_plot <- ggplot(data = df_s10, aes(x = Time, y = Cbratio, color = Day)) + 
  geom_point(size = 4.5) +
  geom_smooth(method = 'lm', se = F, size = 0.9) + # lm = linear regression method 
  scale_x_continuous(breaks = unique(df$Time), 
                     labels = c("0", "3", "6", "12", "24", "48")) +
  sm_hgrid() +
  scale_color_manual(values = sm_color('blue','orange')) +
  scale_y_continuous(limits = c(-3, 5.5)) +
  theme(axis.text = element_text(size = rel(1.5), color = "black"))# axis text size is 1.5x the original font size. 

print(s10_plot)
```

Now let's put them together in a 2x2 figure (2 rows, 2 columns) using the function `plot_grid` from the **cowplot** package.

```{r, fig.width = 7.3, fig.height = 7.3}

together1 <- plot_grid(s1_plot, s5_plot, s6_plot, s10_plot, 
          ncol = 2, # 2 columns in the final figure
          nrow = 2, # 2 rows in the final figure 
          align = 'hv',# set to the same horizontal and vertical lengths of each panel. 
          labels = c('S1','S5','S6','S10'), # each panel label
          label_x = 0.14,# horizontal position of the panel's label relative to each panel. 0 is the very left of the plot.
          label_y = 0.97)  # vertical position of the panel's label relative to each panel. 1 is the very top of the plot. 

print(together1)

save_plot('together1.png',together1,nrow=2,ncol=2,base_asp=0.95) # save as an image. 
```

- Open `together.png` in your directory folder. 

- Note that are some repeating x and y-axes labels. We can remove them. For instance, the top left panel's x-axis labels can be removed because the bottom left panel also has the x-axis labels. 

- Another instance is that the y-axis labels of the top right panel can be removed because the top left panel has the same label. 

- This step is **OPTIONAL**.

```{r, fig.width = 6.86, fig.height = 6.86}

s1_plot_a <- s1_plot + 
  theme(axis.title.x = element_blank()) + # remove x-axis title 
  theme(axis.text.x= element_blank()) + # remove numbers in the x-axis
  theme(axis.title.y = element_blank())  # remove y-axis title 
  
  
s5_plot_a <- s5_plot + 
  theme(axis.title.x = element_blank()) + # remove x-axis title 
  theme(axis.text.x = element_blank()) + # remove numbers in the x-axis
  theme(axis.text.y = element_blank()) + # remove numbers in the y-axis
  theme(axis.title.y = element_blank()) 

s6_plot_a <- s6_plot +
  theme(axis.title.x = element_blank()) + # remove numbers in the x-axis
  theme(axis.title.y = element_blank())

s10_plot_a <- s10_plot +
  theme(axis.title.x = element_blank()) + # remove x-axis title 
  theme(axis.text.y = element_blank()) + # remove numbers in the y-axis
  theme(axis.title.y = element_blank()) 

together2 <- plot_grid(s1_plot_a, s5_plot_a, s6_plot_a, s10_plot_a, 
          ncol = 2, # 2 columns in the final figure
          nrow = 2, # 2 rows in the final figure 
          align = 'hv',# set to the same horizontal and vertical lengths of each panel. 
          labels = c('S1','S5','S6','S10'), # each panel label
          label_x = 0.07, # horizontal position of the panel's label relative to each panel. 0 is the very left of the plot. 
          label_y = 0.97) # vertical position of the panel's label relative to each panel. 1 is the very top of the plot. 

print(together2)

save_plot('together2.png',together2,nrow=2,ncol=2,base_asp=0.95)
```

It seems that there are some empty space between amongst panel. Let's remove them by reducing the margin of each panel. For more information about the function `plot_grid`, please type `?plot_grid` in the console.
- This step is also **OPTIONAL**. 

```{r, fig.width = 6.7, fig.height = 6.7}

s1_plot_b <- s1_plot_a + theme(plot.margin = margin(r=1)) # reduce the empty space of the panel facing to the right to 1 point. Default of ggplot2 is 5.5 points. 

s5_plot_b <- s5_plot_a + theme(plot.margin = margin(r=1, l=1)) # reduce the empty space of the panel facing to the right and left to 1 point. Default of ggplot2 is 5.5 points. 

s6_plot_b <- s6_plot_a + theme(plot.margin = margin(r=1)) # reduce the empty space of the panel facing to the right to 1 point. Default of ggplot2 is 5.5 points. 

s10_plot_b <- s10_plot_a + theme(plot.margin = margin(r=1,l=1)) # reduce the empty space of the panel facing to the right and left to 1 point. Default of ggplot2 is 5.5 points. 

# this step is OPTIONAL
together3 <- plot_grid(s1_plot_b, s5_plot_b, s6_plot_b, s10_plot_b,
          ncol = 2, # 2 columns in the final figure
          nrow = 2, # 2 rows in the final figure 
          align = 'hv',
          labels = c('S1','S5','S6','S10'), # each panel label
          label_x = 0.07) # horizontal position of the panel's label relative to each panel. 0 is the very left of the plot. 

print(together3)

save_plot('together3.png',together3,nrow=2,ncol=2,base_asp=0.95)
```

Now, you need to add the y-axis label (`'Contrast balance ratio'`), x-axis label (`'Minutes after monocular deprivation'`) and the title (`'Recovery of the patching effect'`).

You can do this with **Adobe Illustrator** or directly in **R**. Here, I present a solution with **R**.

You don't have to understand the codes below to use the codes.

```{r, fig.width = 6.5, fig.height = 7.2}

title <- ggdraw() + draw_label('Recovery of the patching effect',
                               size = 17) # title of the combined plot

plot_with_title <- plot_grid(title, together3, ncol = 1, rel_heights = c(0.1 ,1)) # add the title and the combined plot together 

combined_plot <- add_sub(plot_with_title, "Minutes after monocular deprivation", y = 0, vjust = -.3, size = 17) 
# add x-axis title to the combined plot

# add y-axis title to the combined plot
combined_plot <- grid.arrange(combined_plot, left = textGrob("\u0394 Contrast Balance Ratio (dB)", gp = gpar(fontsize = 17), rot = 90))


save_plot("combined_plot.png", combined_plot, ncol = 2, nrow = 2, base_aspect_ratio = .9, limitsize = F)
```